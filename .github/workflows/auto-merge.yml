name: Auto Merge on Green

on:
  workflow_run:
    workflows: ["Android CI"]
    types:
      - completed

jobs:
  merge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Auto-merge PRs labeled automerge
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;

            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: run.head_sha,
            });

            if (!prs.data.length) {
              core.notice('No PR found for this run.');
              return;
            }

            const pr = prs.data[0];
            const labels = pr.labels.map((l) => l.name);
            if (!labels.includes('automerge')) {
              core.notice(`PR #${pr.number} without 'automerge' label, skipping.`);
              return;
            }

            if (pr.state !== 'open') {
              core.notice(`PR #${pr.number} is not open (state=${pr.state}), skipping.`);
              return;
            }

            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash',
                commit_title: pr.title,
              });
              core.notice(`Merged PR #${pr.number} via auto-merge workflow.`);
            } catch (error) {
              core.setFailed(`Merge failed for PR #${pr.number}: ${error.message}`);
            }
